AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Description: Severless MQ Dashboard generator

Metadata:
  AWS::ServerlessRepo::Application:
    Name: mq-dashboards
    Description: AmazonMQ Dashboards
    Author: Sam Andaluri
    SpdxLicenseId: Apache-2.0
    LicenseUrl: license.txt
    ReadmeUrl: README.md
    Labels: ['amazon-mq']
    HomePageUrl: https://github.com/sam-andaluri/mqdashboard
    SemanticVersion: 0.3.0
    SourceCodeUrl: https://github.com/sam-andaluri/mqdashboard

Parameters:
  BrokerRegion:
    Type: String
    Default: "us-east-1"
    Description: (Required) AWS Region.
  MainDBInterval:
    Type: String
    Default: "rate(12 hours)"
    Description: (Required) CW Event schedule interval for main dashboard that enumerates brokers. Default every 12 hours.
  BrokerDBInterval:
    Type: String
    Default: "rate(12 hours)"
    Description: (Required) CW Event schedule interval for broker dashboard that enumerates queues and topics. Default every 12 hours.
  ObjectDbInterval:
    Type: String
    Default: "rate(12 hours)"
    Description: (Required) CW Event schedule interval for object dashboard that generates dashboard for queues and topics. Default every 12 hours.

Resources:
  MainDashboard:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: app.lambda_handler
      Runtime: python3.7
      CodeUri: ./main_dashboard
      Description: 'Main AmazonMQ Dashboard that lists all brokers in a region'
      MemorySize: 128
      Timeout: 60
      Policies:
        - AmazonMQReadOnlyAccess
        - CloudWatchFullAccess
      Environment:
        Variables:
          MQ_REGION: !Ref BrokerRegion
      Events:
        MainInterval:
          Type: Schedule
          Properties:
            Schedule: !Ref MainDBInterval

  BrokerDashboard:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: app.lambda_handler
      Runtime: python3.7
      CodeUri: ./broker_dashboard
      Description: 'Dashboard for a given broker and its associated queues and topics'
      MemorySize: 128
      Timeout: 60
      Policies:
        - AmazonMQReadOnlyAccess
        - CloudWatchFullAccess
      Environment:
        Variables:
          MQ_REGION: !Ref BrokerRegion
      Events:
        BrokerInterval:
          Type: Schedule
          Properties:
            Schedule: !Ref BrokerDBInterval

  ObjectDashboard:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: app.lambda_handler
      Runtime: python3.7
      CodeUri: ./object_dashboard
      Description: 'Dashboard for a given queue or topic'
      MemorySize: 128
      Timeout: 60
      Policies:
        - AmazonMQReadOnlyAccess
        - CloudWatchFullAccess
      Environment:
        Variables:
          MQ_REGION: !Ref BrokerRegion
      Events:
        ObjectInterval:
          Type: Schedule
          Properties:
            Schedule: !Ref ObjectDbInterval

